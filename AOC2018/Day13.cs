using System;
using System.Collections.Generic;
using System.Text;
using System.Linq;
using System.Text.RegularExpressions;
using System.Security.Cryptography;

namespace AOC2018
{
    public class Day13
    {
        static Dictionary<char, int> directions = new Dictionary<char, int>() { { '>', 3 }, { '<', 9 }, { 'v', 6 }, { '^', 0 } };
        public static void Main()
        {
            var input = @"                                   /--------------------------------------------------------------------------------------------\                     
                                   |                    /-------------------------------\                                       |                     
                                   |              /-----+-----------\                   |                                       |                     
  /--------\ /--------------------\|              |     | /---------+--------------\    |               /-----------------------+-----\               
  |        | |        /-----------++--------------+-----+-+---------+----\       /-+----+---------------+--------------\        |     |               
  |        | |        |           ||              |     |/+---------+----+-------+-+----+---------------+--------------+--------+-----+-------------\ 
/-+--------+-+--------+-----------++--------------+-----+++---------+----+-------+-+----+-----\         |              |     /--+-----+-----\       | 
| |     /--+-+--------+-----------++--------------+-----+++---------+----+-------+-+----+-----+---------+-----\        |     |  |     |     |       | 
| | /---+<-+-+--------+-----------++--------------+-----+++---------+----+-------+-+----+-----+----\    |     |        |     |  |     |  /--+------\| 
| | |   |  | |        |/----------++------------<-+-----+++---------+----+------\| |    |     |    |    |     |        |     |  |     |  |  |      || 
| | |   |  | |      /-++----------++--------------+-----+++---------+----+------++-+----+-----+----+----+-----+------\ |     |  |     |  |  |      || 
| | |   |  | |      | ||    /-----++--------------+-----+++--\      |    |      || |    |     |    |    |     |      | |     |  |     |  |  |      || 
| | |   |  | |      | ||    |     ||              |     |||  |      |    |      || |    |     |    |    |     |      | |     |  |     |  |  |      || 
| | |   |  ^ |      | ||    |     ||              |     |||  |      |    |      || |    |     |    |    |     |      | |     |  |     |  |  |      || 
| | |/--+--+-+------+-++----+\    ||              |     |||  |      |    |      || |/---+-----+----+----+-----+------+-+-----+--+-----+-\|  |      || 
| | ||  |  | |  /---+-++----++----++--------------+-----+++--+------+----+------++-++---+-----+----+----+-----+------+-+----\|  |    /+-++--+------++\
| | ||/-+--+-+--+---+-++----++----++-----\        |     |||  |      |    |      || ||   |     |    |    |     |      | |    ||  |    || ||  |      |||
| | ||| |  | |  |   | ||/---++----++-----+--------+-----+++-\|      | /--+------++-++-\ |     |    |    |     |      | |    ||  |    || ||  |      |||
| | ||| |  | |  |   | |||   ||/---++-----+--------+-----+++-++------+-+--+------++-++-+-+-----+----+----+--\  |      | |    ||  |    || ||  |      |||
| | ||| |  | |  |   \-+++---+++---++-----+--------+-----+++-++------+-+--+------++-++-+-+-----+----+----+--+--+------/ |    ||  |    || ||  |      |||
| | ||| |  | |  |     |||   |||   ||     |  /-----+-----+++-++------+-+--+-----\|| || | |     |    |    |  |  |        |    ||  |    || ||  |      |||
| | ||| |  | |  |     \++---+++---++-----+--+-----+-----+++-++------+-+--/     ||| || | |    /+----+----+--+--+--------+----++--+----++-++--+\     |||
| | |||/+--+-+--+------++---+++---++-----+--+-----+-----+++-++------+-+--------+++-++-+-+----++----+----+--+--+---\    |    ||  |    || ||  ||     |||
| | |||||  | |  |      \+---+++---++-----+--+-----+-----+++-++------+-+--------+/| || | |    ||    |    |  |  |   |    |    ||  |    || ||  ||     |||
| | |||||  | |  |       |/--+++---++-----+--+-----+-----+++-++------+-+--------+-+-++-+-+----++----+--\ |  |  |   |    |    ||  |    || ||  ||     |||
| | ||||\--+-+--+-------++--+++---++-----+--+-----+-----+++-++------+-+--------+-+-++-+-+----++----+--+-+--+--/   |    |    ||  |    || ||  ||     |||
| | ||||   | |  |       ||  |||   ||     |  |     |  /--+++-++------+\|        | | || | |    ||    |  | |  |      |    |    ||  |    \+-++--++-----++/
| | ||||   | |  |       ||  |||   ||     |  |     |  |  ||| ||      |||  /-----+-+-++-+-+----++----+--+-+--+------+----+----++--+-----+\||  ||     || 
| |/++++---+-+-\|       ||  |||   ||     |  |     |  |  ||| ||      |||  |     | | || | |    ||    |  | |  |      |    |    ||  |     ||||  ||     || 
| ||||\+---+-+-++-------++--+++---++-----/  |     |  |  |||/++------+++--+-----+-+-++-+-+----++----+--+-+--+------+----+----++--+---\ ||||  ||     || 
| |||| |   | | ||       ||  |||   ||        |     |  |  ||||||      ||| /+-----+-+-++-+-+----++----+--+-+--+------+---\|    ||  |   | ||||  ||     || 
| |||| |   | | ||       ||  |||   ||        |     |  |  ||||||      ||| ||     | | || | |    ||    |  | |  |      |   ||    ||  |   | ||||  ||     || 
| |||| |   | | ||       ||  \++---++--------+-----+--+--+++++/      ||| ||     | | || | |    ||    |  | |  |      |   ||    ||  |   | ||||  ||     || 
| |||| |   | | ||      /++---++---++--------+-----+--+--+++++-------+++-++-----+-+-++-+-+----++----+--+-+--+------+---++----++--+-\ | ||||  ||     || 
| |||| |   | | ||      |||   ||   ||        |     |  |  |||||  /----+++-++-----+-+-++-+-+----++----+--+-+--+------+---++---\||  | | | ||||  ||     || 
| |||| |   |/+-++------+++---++---++--------+-----+--+--+++++--+----+++-++-----+-+-++-+\|    ||    |  | ^  |      |   ||   |||  | | | ||||  ||     || 
| |||| |   ||| ||      |||   ||   ||        |/----+--+--+++++--+----+++-++-----+-+-++-+++--\ ||    |  | |  |      |   ||   |||  | | | ||||  ||     || 
| |||| |   ||| ||      |||   ||   ||        ||    |  |  |||||  |    ||| ||     | |/++-+++--+-++----+--+-+--+------+---++\  |||  | | | ||||  ||     || 
| |||| |   ||| ||      |||   ||   ||        ||    |  | /+++++--+----+++-++-----+-++++-+++--+-++----+--+-+--+------+---+++--+++--+-+-+-++++--++---\ || 
| |||| |   ||| ||      |||   ||   ||        ||    | /+-++++++--+----+++-++-----+-++++-+++--+-++-\  |  | |  |      |   |||  |||  | | | ||||  ||   | || 
| |||| | /-+++-++--\   |||   ||   ||    /---++----+-++-++++++--+----+++-++-----+-++++-+++--+-++-+--+--+-+--+--\   |   |||  |||  | | | ||||  ||   | || 
| |||| | | ||| ||  |   |||   ||   ||/---+---++----+-++-++++++--+----+++-++-----+-++++-+++--+-++\|  |  | \--+--+---+---+++--+++--+-+-+-/|||  ||   | || 
| |||| | | ||| ||  |   |||   |\---+++---+---++----+-++-++++++--+----+++-++-----+-++++-+++--+-++++--+--+----/  |   |   |||  |||  | | |/-+++--++-\ | || 
| |||| | | ||| ||  |   |||   |    |||   |   ||   /+-++-++++++--+----+++-++-----+-++++-+++--+-++++--+--+------\|   |   |||  |||  | | || |v|  || | | || 
| |||| | | ||| ||  |   |||   |    |||   |   ||   || || ||||||  |    ||| ||     | |||| |||  | ||||  |  |      ||   |   |||  |||  | | || |||  || | | || 
| |||| | | ||| || /+---+++---+---\|||   |   ||   || || ||\+++--+----+++-++-----+-++++-+++--+-++++--+--+------++---+---+++--+++--+-+-++-+++--++-+-+-+/ 
| |||| \-+-+++-++-++---+++---+---++++---+---++---++-++-++-+++--+----+++-++-----+-++++-+++--+-++++--+--+------++---/   |||  |||  | | || ||\--++-+-+-/  
| ||||   | ||| || ||   |||   |   ||||   |   ||   || || || |||  |    ||| ||/----+-++++-+++--+-++++--+--+------++-------+++--+++\ | | || ||   || | |    
| ||||   | ||| || || /-+++---+---++++---+---++---++\||/++-+++--+----+++-+++----+-++++-+++--+-++++--+-\|      ||       |||  |||| | | || ||   || | |    
| ||||   | ||| || || | |||  /+---++++--\|   ||   |||||||| |||  |    ||| |||    | |||| |||  | ||||  | ||      ||       |||  |||| | | || ||   || | |    
| ||||   | ||| || || | |||/-++---++++--++---++---++++++++-+++--+----+++-+++----+-++++\|||  | ||||  | ||      ||       |||  |||| | | || ||   || | |    
| ||||   | ||| || || | |||| ||   |||| /++---++---++++++++-+++--+----+++-+++----+-++++++++--+-++++--+-++------++--\    |||  |||| | | || ||   || | |    
| ||||   | ||| || || | ||||/++---++++-+++---++---++++++++-+++--+----+++-+++----+-++++++++--+-++++--+-++------++--+----+++--++++-+-+\|| ||   || | |    
| ||||   | ||| || || | |||||||   |||| |||   ||   |||||||| |||  |    ||| |||/---+-++++++++--+-++++--+-++------++--+----+++--++++-+-++++\||   || | |    
| ||||   | ||| || || | ||\++++---++++-+++---++---++++++++-+++--+----+++-++++---+-++++++++--+-++++--+-+/      ||  |    |||  |||| | |||||||  /++-+-+--\ 
| ||||   | ||| || || | || ||||   |||| ^||   ||   |||||||| |||  |    ||| ||||/--+-++++++++--+-++++--+-+-------++--+----+++--++++-+-+++++++--+++-+-+\ | 
| ||||   | |\+-++-++-+-++-++++---++++-+++---++---++++++++-+++--+----+++-+++++--+-++++++/|  | ||||  | |       ||  |    |||  |||| | |||||||  ||| | || | 
| ||||   | | | || || | || ||||   ||||/+++---++---++++++++-+++--+----+++-+++++--+-++++++-+--+-++++--+-+-------++--+----+++--++++-+-+++++++--+++\| || | 
| ||||   | | | || || | || |||v   |||||||| /-++---++++++++-+++--+-\  ||| |||||  | |||||| |  | ||||  | |  /-<--++--+----+++-\|||| | |||||v|  ||||| || | 
| ||||   | | | || || | || ||||   |||||||| | ||   |||||||| ||| /+-+--+++-+++++--+-++++++-+\ | ||||  | |  |    ||  |    ||| ||||| | |||||||  ||||| || | 
| ||||   | | | || || |/++-++++-\ |||||||| | ||   |||||||| ||| || |  ||| |||||  | |||||| || | ||||  | |  |    ||  |    ||| ||||| | |||||||  ||||| || | 
|/++++---+-+-+-++-++-++++-++++-+-++++++++-+-++---++++++++-+++-++-+--+++-+++++\ | |||||| || | ||||  | |  |    ||  |    ||| ||||| | |||||||  ||||| || | 
||||||   | | | || || |||| |||| | |||||||| | ||   |||||||| ||| ||/+--+++-++++++-+-++++++-++-+-++++--+\|  |    ||  |    ||| ||||| | |||||||  ||||| || | 
||||||   | | | || || |||| |||| | |||||||| | ||   \+++++++-+++-++++--+++-++++++-+-++++++-++-+-++++--+++--+----/|  |    ||| ||||| | |||||||  ||||| || | 
||||||   | | | || || |||| |||| | |||||||| | ||  /-+++++++-+++-++++--+++-++++++-+-++++++-++-+-++++--+++-\|     |  |    ||| ||||| | |||||||  ||||| || | 
||||||  /+-+-+-++-++-++++-++++-+-++++++++-+-++--+-+++++++-+++-++++--+++-++++++-+-++++++-++-+-++++--+++-++-----+\ |    ||| ||||| | |||||||  ||||| || | 
||||||  || | | || || |||| |||| | |||||||| v ||  | \++++++-+++-++++--/|| ||\+++-+-++++++-++-+-++++--+++-++-----++-+----+++-++++/ | |||\+++--++++/ || | 
||||||  || | | || || |||| |||| | |||||||| | ||  |  |||||| ||| ||||   |\-++-+++-+-+++++/ || | ||||  ||| ||     || |    ||| ||||  | ||| |||  ||||  || | 
||||||  || | | || || |||| |||| | |||||||| | ||  |  |||||| ||| |||| /-+--++-+++-+-+++++--++-+-++++--+++-++-\   || |    ||| ||||  | ||| |||  ||||  || | 
||||||  || | | || || |||| |||| | |||||||| | ||  |  |\++++-+++-++++-+-+--++-+++-+-+++++--++-+-+++/  ||| || |   || |    ||| ||||  | ||| |||  ||||  || | 
||||||  || | | || || |||| |||| | |||||||| | ||  |  | |||| ||| |||| | |  \+-+++-+-+++++--++-+-+++---+++-++-+---++-+----/|| ||||  | |||/+++--++++\ || | 
||||||  || | | || || |||| |||| | |||||||| | ||  |  | |||| ||| |||| | |   | ||| | |||||  || | |||   ||| || |   || |     || ||||  | |||||||  ||||| || | 
||||||  || | | || || |||| |||| |/++++++++-+-++--+--+-++++-+++-++++-+-+---+-+++-+-+++++--++-+-+++---+++-++-+---++-+-\   || ||||  | |||||||  ||||| || | 
||||||  || | | || || ||\+-++++-++++++++++-+-++--+--+-++++-+++-++++-+-+---+-+++-+-+++++--++-+-+++---+++-++-+---++-+-+---++-++++--+-/||||||  ||||| || | 
||||||  || | | || || || | |||| ||||||\+++-+-++--+--+-++++-+++-++++-+-+---+-+++-+-+++++--++-+-+++---+++-++-+---++-+-+---++-++++--+--++++++--+++/| || | 
||||||  || | | || || || | |||| |||||| ||| | ||/-+--+-++++-+++-++++-+-+-\ | ||| | |||||  || | |||   ||| || |   || | |   || ||||  |  ||||||  ||| | || | 
||||||  || | | || || || |/++++-++++++-+++-+<+++-+--+-++++-+++-++++-+-+-+-+-+++-+-+++++--++-+\|||   ||| || |   || | |   || ||||  |  ||||||  ||| | || | 
||||||  || | | |\-++-++-++++++-++++++-+++-+-+++-+--+-++++-+++-++++-+-+-+-+-+++-+-+++++--++-+++++---+++-++-+---++-+-+---++-++/|  |  ||||||  ||| | || | 
\+++++--++-+-+-+--++-++-++++++-++++++-+++-+-+++-+--+-++++-+++-++++-+-+-+-+-+++-+-+++++--++-+++/|/--+++-++-+---++-+-+---++-++-+--+--++++++--+++\| || | 
 ||||| /++-+-+-+--++-++-++++++-++++++-+++-+\||| |  | |||| ||| |||| | | | |/+++-+-+++++\ || ||| ||  ||| || | /-++-+-+---++-++-+--+--++++++--+++++-++\| 
 ||||| ||| | | |  \+-++-++++++-++/||| ||| ||||| |  | |||| ||| |||| | | | ||||| | |||||| || ||| ||  ||| || | | || | |   || || |  |  ||||||  ||||| |||| 
 ||||| ||| | | |   | || |||||| || ||| ||| \++++-+--+-++++-+++-+++/ | | | ||||| | |||||| || ||| ||  ||| || | | || | |   || || \--+--++++++--+/||| |||| 
 ||||| ||| | | |   | || ||||||/++-+++-+++--++++-+--+-++++-+++-+++--+-+-+-+++++-+-++++++-++-+++-++--+++-++-+-+-++-+-+\  || ||    |  ||||||  | ||| |||| 
 ||||| ||| | | |   | || ||||||||| ||| |||  |||| |  | |||| ||| ||| /+-+-+-+++++-+-++++++-++-+++-++--+++-++-+-+-++-+-++--++-++----+--++++++--+-+++\|||| 
 ||||| ||| | | |   | || ||||||||\-+++-+++--++++-+--+-++++-+++-+++-++-+-+-+++++-+-++++++-++-+++-++--+++-++-+-+-++-+-/|  || ||    |  ||\+++--+-++/||||| 
 ||||| ||| | | |   | || ||||||||/-+++-+++-\|||| |  | |||| ||| ||\-++-+-+-+++++-+-++++++-++-+++-++--+/| || | | || |  |  || ||    |  || |||  | || ||||| 
 ||||| ||| | | |   | |\-+++++++/| |||/+++-+++++-+--+\|||| ||| ||  || | | ||||| | |||||| || ||| ||  | | || | | || |  |  || ||    |  || |||  \-++-++++/ 
 ||||| ||| | | |   | |  ||||||| | ||||||| ||||| |  |||||| ||| |\--++-+-+-+++++-+-++++++-++-+++-++--+-+-++-+-+-++-+--+--++-+/    |  || |||    || ||||  
 ||||| ||| | | |   | |  ||||\++-+-+++++/| ||||| |  |||||| ||| |   || | | ||||| |/++++++-++-+++-++--+-+-++-+-+-++-+--+-\|| |     |  || |||    || ||||  
 ||||| ||| | | |   | |  |||| || | ||||| | ||||| |  |||||| ||| |   || | | ||||| ||\+++++-++-+++-++--+-+-++-+-+-++-+--+-+/| |     |  || |||    || ||||  
 ||||| ||| | | |   | |  |||| || | ||||| | ||||| |  |||||| ||| |   || | | ||||| || ||||| || ||| ||  | | || | | || |  | | | |     |  || |||    || ||||  
 ||||| ||| | | |   | |  |||| || | ||||| | ||||| |  |||||| ||| |   || | | ||||| || ||||| || ||| |\--+-+-++-+-+-++-+--+-+-+-+-----+--++-+++----+/ ||||  
 ||||| ||| | \-+---+-+--++++-++-+-/\+++-+-+++++-+--++++++-+++-+---++-+-+-+++++-++-+++++-++-+++-+---+-+-++-+-+-++-+--+-+-+-+-----/  || |||    |  ||||  
 ||||| ||| |   |   | |  |||| || |   ||| | ||||| |  |||\++-+++-+---++-+-+-+++++-++-+++++-++-+++-+---+-/ || | | || |  | | | |        || |||    |  ||||  
 ||||| ||| | /-+---+-+--++++-++-+-\ ||| | ||||| |  ||| \+-+++-+---++-+-+-+++++-++-+++++-++-+++-+---+---++-+-+-++-+--+-+-+-+--------++-+++----+--+/||  
 ||||| ||| | | |   | |  |||| || | | ||| | ||||| |  |||  | ||| |   || | | |||||/++-+++++-++-+++-+---+---++-+-+-++-+--+-+-+-+-------\|| |||    |  | ||  
 ||||| ||| | | |   | |  |||| || | | |||/+-+++++-+--+++--+-+++-+---++-+-+-++++++++-+++++\|| ||| |   |   || | | || |  | | | |       ||| |||    |  | ||  
 ||||| ||| | | |   | |  |||| || | | ||||| ||||| |  |||  | ||| |   || | | |||||||| |||||||| ||| |/--+---++-+-+-++-+--+-+-+-+-------+++-+++----+-\| ||  
 |||\+-+++-+-+-+---+-+--++++-++-+-+-+++++-+++++-+--+++--+-+++-+---++-+-+-++++++++-++++++++-+++-++--/   || | | || |  | | | |       ||| |||    | || ||  
 ||| | ||| | | |   | |  |||| || | | ||||| ||||| |  |||  | ||| |   || | | |||||||| |||||||| ||| ||      || | | || |  | | | |       ||| |||    | || ||  
 ||| | ||| | | |   | |  |||| || | |/+++++-+++++-+--+++--+-+++-+---++-+-+>++++++++\|||||||| ||| ||      || | | || |  | | | |       ||| |||    | || ||  
 ||| | ||| | | |   | |  |||| || | ||||||| ||||| |  |||  | ||| \---++-+-+-++++++++++++++++/ ||| ||      || | | || |  | | | |       ||| |||    | || ||  
 ||| | ||| | | |   | |  |||| || | ||||||| ||||| |  |||  | |||     || | | ||||||||||||||||  ||| ||      || | | || |  | | | |       ||| |||    | || ||  
 ||| | ||| | | |   | |  |||| || | ||||||| ||||| |  |||  | |||     || | | ||||||||||||||||  ||\-++------++-+-+-++-+--+-+-+-+-------+++-+++----/ || ||  
 ||| | ||| | \-+---+-+--++++-++-+-/|||||| ||||| |  |||  | \++-----++-+-+-++++++++++/|||||  ||  ||      || | | || |  | | | |/------+++-+++------++-++-\
 \++-+-+++-+---+---+-+--++++-++-+--++++++-+++++-+--+++--+--++-----++-+-+-++++/\++++-+++++--++--++------++-+-+-++-+--+-+>+-++------/|| |||      || || |
  || | ||| |   |   | |  |||| || |  ||\+++-+++++-+--+/|  |  ||     || | | ||||  |||| |||||  ||  |\------++-+-+-++-+--+-+-+-++-------++-+++------/| || |
  || | ||| |   |   | |  |||| || \--++-+++-/|\++-+--+-+--+--++-----++-+-+-++++--/||| |||||  ||  |       || | | || |  | | | ||       || |||       | || |
  || \-+++-+---+---+-+--++++-/|    || |||  | || |  | \--+--++-----++-/ | ||||   ||| |||||  ||  |   /---++-+-+-++-+--+-+-+-++-------++-+++\      | || |
/-++---+++-+---+---+-+--++++--+\   || |||  | || |  |    \--++-----++---+-++++---+++-++++/  ||  |   |   || | | || |  | | | ||       || ||||      | || |
| ||   ||| |   |   | |  ||||  ||   || ||\--+-++-+--+-------++-----++---+-++++---+++-++++---++--+---+---++-+-+-/| |  | | | ||       || ||||      | || |
| \+---+++-/   |   | |  ||||  ||   || ||   | || |  |       ||     ||   | \+++---+++-++++---++--+---+---++-+-+--+-+--+-+-+-++-------++-+/||      | || |
|  |   |||     |   | |  ||||  ||   || ||   | || |  |       \+-----++---+--+++---+++-++++---++--+---+---++-+-+--+-+--+-+-+-++-------+/ | ||      | || |
|  |   |||     |   | |  ||||  \+---++-++---+-++-+--+--------+-----++---+--+++---+++-++++---++--+---+---++-+-+--+-+--/ | | ||       |  | ||      | || |
|  |   |||     |   | |  ||||   |   || ||   | \+-+--+--------+-----++---+--+++---+++-++++---/|  |   |   || | |  | |    | | ||       |  | ||      | || |
|  |   |||     |   | |  \+++---+---++-++---+--+-+--+--------/     ||   |  ||\---+++-++++----+--+---+---++-+-+--+-+----+-+-++----->-+--+-++------+-/| |
|  |   |||     |   | \---+++---+---++-++---+--+-+--/              |\---+--++----+++-++++----+--+---+---++-/ |/-+-+----+-+-++-------+--+-++--\   |  | |
|  |   |||     |   |     |||   |   || ||   |  | |                 |    |  ||    ||| \+++----+--+---+---++---++-+-+----+-+-++-------+--+-/|  |   |  | |
|  |   |||     |   |     |||   |   || ||   |  | |                 |    |  ||    |||  |||    |  |   |   ||   \+-+-+----+-+-++-------+--+--+--+---+--/ |
|  |   |||     |   |     |||   |   || ||   |  | |                 |    |  ||    |||  |||    |  |   |   ||    | | |    | | ||       |  |  |  |   |    |
|  |   |||     | /-+-----+++---+---++-++---+--+-+-----------------+----+--++----+++--+++---\|  |   |   ||    | | |    | | ||       |  |  |  |   |    |
|  |   |\+-----+-+-+-----+++---+---++-++---+--+-+-----------------+----+--++----+++--+++---++--+---+---++----+-//+----+-+-++-------+--+--+--+---+---\|
|  |   | |     | | |     |||   |   || ||   |  | |                 \----+--++----+++--+++---++--+---+---++----+--++----+-+-++-------+--+--+--+---/   ||
|  |/--+-+-----+-+-+-----+++---+---++-++---+--+-+----------------------+--++----+++--+++---++--+---+--<++----+\ ||/---+-+-++-------+--+--+--+------\||
|  ||  | |     | | |     |||   |   || |\---+--+-+----------------------+--++----+++--++/   ||  |   |   ||    || |||   | | ||       |  |  |  |      |||
|  ||  | |     | | |     |||   |   || |    |  | |                      |  ||    \++--++----++--+---+---++----++-+++---/ | ||       |  |  |  |      |||
|  ||  | |    /+-+-+-----+++---+---++-+----+--+-+-------------\        |  ||     ||  ||    ||  |   |   |\----++-+++-----+-/|       |  |  |  |      |||
|  ||  | |    || | |     |||   |   |\-+----+--+-+-------------+--------+--++-----++--++----++--/   |   |     || |||     |  |       |  |  |  |      |||
|  \+--+-+----+/ | |     |||   |   |  \----+--+-+-------------+--------+--++-----++--++----++------+---+-----++-+/|     |  |       |  |  |  |      |||
|   |  | |    |  | |     |||   |   |       |  | |             |        |  ||     ||  ||    ||      |   |     || | |     |  |       |  |  |  |      |||
|   |  | |    |  | |     |||   |   \-------+--+-+-------------+--------+--++-----/|  ||    ||      |   |     \+-+-+-----+--+-------+--+--+--/      |||
|   |  | |    |  | |     |||   |           |  | |    /--------+--------+--++------+--++----++------+---+------+-+-+-----+--+--\    |  |  |         |||
|   |  | |    |  | |     \++---+-----------+--+-+----+--------+--------+--++------+--++----+/      |   |      | | |  /--+--+--+----+--+--+------\  |||
\---+--+-+----+--+-+------++---/           |  | |    |        |        |  ||      \--++----+-------+---+------+-+-+--+--/  |  |    |  |  |      |  |||
    |  \-+----+--+-+------++---------------/  | |    |        |    /---+--++---------++----+----\  \---+------+-+-+--+->---+--+----+--+--/      |  |||
    |    |    |  | |      |\------------------+-+----+--------+----+---+--++---------++----+----+------+------+-+-+--+-----+--+----/  |         |  |||
    |    |    |  | |      |                   | \----+--------+----+---+--++---------++----+----+------/      | | |  |     |  |       |         |  |||
    |    |    |  | |      |/------------------+------+--------+----+---+--++---------++----+----+------\      | | |  |     |  |       |         |  |||
    |    |    |  | |      ||                  | /----+--------+----+---+--++---------++----+----+------+------+-+-+--+-----+--+-------+---------+\ |||
    |    |    |  \-+------++------------------+-+----+--------+----+---+--++---------++----/    |      |      |/+-+--+-----+--+-----\ |         || |||
    |    |    \----+------++------------------+-+----+--------/    |   |  \+---------+/         |      |      ||\-+--+-----+--+-----+-+---------++-+/|
    \----+---------+------++------------------+-+----+-------------+---+---+---------+----------+------+------/|  \--+-----+--+-----+-+---------++-/ |
         |         |      ||                  | |    |             |   |   \---------+----------+------+-------+-----+-----+--+-----+-/         ||   |
         |         |      ||                  | |    |             \---+-------------+----------/      |       |     \-----+--+-----+-----------/|   |
         \---------/      \+------------------+-+----+-----------------+------------</                 |       |           |  |     |            |   |
                           |                  \-+----+-----------------/                               |       |           |  |     |            |   |
                           |                    |    \-------------------------------------------------+-------+-----------+--/     |            |   |
                           |                    |                                                      |       |           \--------+------------+---/
                           |                    \------------------------------------------------------+-------+--------------------+------------/    
                           \---------------------------------------------------------------------------/       \--------------------/                 ";
            /*input = @"/>-<\  
|   |  
| /<+-\
| | | v
\>+</ |
  |   ^
  \<->/";*/
            var rail = new List<char[]>();
            foreach (var line in input.Split(new char[] { '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries))
            {
                rail.Add((" " + line + " ").ToCharArray());
            }
            rail.Add(new string(' ', rail[0].Length).ToCharArray());
            rail.Insert(0, rail[^1]);
            int r = rail.Count;
            int c = rail[0].Length;
            var presence = new HashSet<(int row, int col)>();
            var wagons = new SortedSet<(int row, int col, int direction, int intersection)>();
            for (int i = 0; i < r; i++)
            {
                for (int j = 0; j < c; j++)
                {
                    if (!"<>v^".Contains(rail[i][j])) continue;
                    wagons.Add((i, j, directions[rail[i][j]], 0));
                    Clear(rail, i, j);
                    presence.Add((i, j));
                }
            }
            while (wagons.Count > 1)
            {
                var nextWagons = new SortedSet<(int row, int col, int direction, int intersection)>();
                foreach (var wagon in wagons)
                {
                    (int row, int col, int direction, int intersection) = wagon;
                    // This means that the wagon is not present anymore so one wagon crashed on it
                    if (!presence.Remove((row, col)))
                        continue;
                    switch (direction)
                    {
                        case 0: row--; break;
                        case 6: row++; break;
                        case 9: col--; break;
                        case 3: col++; break;
                    }
                    if (presence.Contains((row, col)))
                    {
                        // IMPACT
                        Console.WriteLine($"{col - 1}, {row - 1}");
                        // On ramasse les débris.
                        presence.Remove((row, col));
                        nextWagons.RemoveWhere(wag => wag.col == col && wag.row == row);
                        //Console.ReadLine();
                        continue;
                    }
                    // GPS du wagon.
                    presence.Add((row, col));
                    if (rail[row][col] == ' ')
                    {
                        Console.WriteLine("Houston, on a un problème");
                    }
                    if (rail[row][col] == '/')
                    {
                        direction = direction < 5 ? 3 - direction : 15 - direction;
                    }
                    if (rail[row][col] == '\\')
                    {
                        direction = 9 - direction;
                    }
                    if (rail[row][col] == '+')
                    {
                        // left, straight, right
                        if (intersection == 0)
                            direction = (direction + 9) % 12;
                        else if (intersection == 2)
                            direction = (direction + 3) % 12;

                        intersection = (intersection + 1) % 3;
                    }
                    nextWagons.Add((row, col, direction, intersection));
                }
                wagons = nextWagons;
            }
            Console.WriteLine($"{wagons.First().col - 1}, {wagons.First().row - 1}");
        }

        private static void Clear(List<char[]> rail, int i, int j)
        {
            if ("^v".Contains(rail[i][j])) rail[i][j] = '|';
            else rail[i][j] = '-';
        }
    }

}
